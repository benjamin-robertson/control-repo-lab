config:
  enable_pull_requests_from_forks: false
  deployment_policy_branch: "production"
  enable_pe_plans: true
pipelines:
  /feature_.*/:
    triggers:
    - "COMMIT"
    - "PULL_REQUEST"
    stages:
    - name: "Code Validation stage"
      steps:
      - type: "JOB"
        name: "control-repo-manifest-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-hiera-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-template-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-puppetfile-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      auto_promote: "all_succeeded"
    - name: "Deployment stage"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment on lab"
        policy:
          name: "cd4pe_deployments::feature_branch"
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
      auto_promote: false
  main:
    triggers:
    - "COMMIT"
    - "PULL_REQUEST"
    stages:
    - name: "Code Validation stage"
      steps:
      - type: "JOB"
        name: "control-repo-manifest-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-hiera-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-template-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      - type: "JOB"
        name: "control-repo-puppetfile-syntax-validate"
        concurrent_compilations: 0
        all_deployments: false
      auto_promote: "all_succeeded"
    - name: "Deployment stage"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment to development on lab"
        policy:
          name: "cd4pe_deployments::eventual_consistency"
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
          node_group_id: "72340c21-dbf1-4f73-885c-d19bfc41f9ae"
      auto_promote: "all_succeeded"
    - name: "Main Prod deploy"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment to production on lab"
        policy:
          name: "cd4pe_deployments::rolling"
        parameters:
          noop: false
          fail_if_no_nodes: true
          batch_delay: 10
          batch_size: 10
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
          node_group_id: "5ee6e69e-745c-42f1-ae23-acaee09e4c1b"
      auto_promote: "all_succeeded"
    - name: "Prod Deploy 1"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment to prod_group_1 on lab"
        policy:
          name: "cd4pe_deployments::rolling"
        parameters:
          noop: false
          fail_if_no_nodes: true
          batch_delay: 10
          batch_size: 10
          max_node_failure: 1
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
          node_group_id: "1d8dcd39-bfb2-426c-b835-f3e7f9a85b61"
      auto_promote: "all_succeeded"
    - name: "Prod Deploy 2"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment to prod_group_2 on lab"
        policy:
          name: "cd4pe_deployments::rolling"
        parameters:
          noop: false
          fail_if_no_nodes: true
          batch_delay: 10
          batch_size: 10
          max_node_failure: 1
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
          node_group_id: "1c5982ec-7ff3-4d3e-a2db-37fc8391afdb"
      auto_promote: "all_succeeded"
    - name: "Prod Deploy 3"
      steps:
      - type: "DEPLOYMENT"
        name: "Deployment to prod_group_3 on lab"
        policy:
          name: "cd4pe_deployments::rolling"
        parameters:
          noop: false
          fail_if_no_nodes: true
          batch_delay: 10
          batch_size: 10
          max_node_failure: 1
        timeout: 3600000
        concurrent_compilations: 0
        all_deployments: false
        pe_server: "lab"
        target:
          type: "NODE_GROUP"
          node_group_id: "03c55528-5265-462f-8b40-7f3e794a6b8f"
      auto_promote: false
spec_version: "V1"
