BRANCH=$(git branch | awk '{ print $2 }')
REF_BRANCH=prod_group_2
git branch | grep ' release_*'
if [ $? -ne 0 ] 
then
  echo "bailing out, not release branch"
  exit 0
fi
echo "in release branch"
SERVER=`git config remote.origin.url | awk -F '@' '{ print $2 }' | awk -F '/' '{ print $1 }' | awk '{ print "https://"$1"/api/v4/" }'`
echo $SERVER
echo "Get control repo url"
CONTROL_REPO=`git config remote.origin.url | awk -F '@' '{ print $2 }' | awk -F '/' '{ print $2"%2f"$3 '} | sed 's/.git//'`
echo $CONTROL_REPO
# create tag in control repo and protect the new branch
curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${CONTROL_REPO}/repository/tags?tag_name=${BRANCH}\&ref=${BRANCH}
echo "curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${CONTROL_REPO}/repository/tags?tag_name=${BRANCH}\&ref=${BRANCH}"
curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${CONTROL_REPO}/protected_branches?name=${BRANCH}
echo "curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${CONTROL_REPO}/protected_branches?name=${BRANCH}"
exit 0
for repo in `cat gitrepos`
do
  curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${repo}/repository/branches?branch=${BRANCH}\&ref=${REF_BRANCH}
  echo "curl --request POST --header \"PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN\" ${SERVER}projects/${repo}/repository/branches?branch=${BRANCH}\&ref=${REF_BRANCH}"
  curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${repo}/repository/tags?tag_name=${BRANCH}\&ref=${REF_BRANCH}
  echo "curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${repo}/repository/tags?tag_name=${BRANCH}\&ref=${REF_BRANCH}"
  curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${repo}/protected_branches?name=${BRANCH}
  echo "curl -k --request POST --header "PRIVATE-TOKEN: $CD4PE_SECRET_GITLAB_TOKEN" ${SERVER}projects/${repo}/protected_branches?name=${BRANCH}"
done